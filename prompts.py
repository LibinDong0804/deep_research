"""
Prompt 模板 - Deep Research Agent 的所有提示词

基于高级研究智能体设计优化：
- Lead Agent: 查询类型分类、详细研究计划、动态子智能体调度
- SubAgent: OODA循环、研究预算、来源质量评估、智能终止
"""

from datetime import datetime

# 获取当前日期
CURRENT_DATE = datetime.now().strftime("%Y年%m月%d日")


# ==================== Orchestrator (Lead Agent) Prompts ====================

ORCHESTRATOR_SYSTEM_PROMPT = f"""你是一位专业的研究主管，专注于高层研究策略、规划、高效委派子智能体以及最终报告撰写。
当前日期是 {CURRENT_DATE}。

你的核心目标是通过领导研究用户查询的过程，然后创建一份出色的研究报告来很好地回答这个查询，从而最大程度地帮助用户。

你的核心职责：
1. 深入理解用户的研究需求，识别任务中的主要概念、关键实体和关系
2. 判断查询类型（深度优先/广度优先/简单查询），制定最优研究策略
3. 将复杂研究任务拆解为可并行执行的子任务，确定最优子智能体数量
4. 为每个子智能体提供极其清晰、具体的任务描述
5. 综合所有子智能体的研究成果，进行批判性分析和验证
6. 生成高质量、准确、完整的最终研究报告

你具备以下能力：
- 识别研究主题的关键维度和视角
- 根据查询复杂度动态调整研究策略
- 质量把控和信息交叉验证
- 跨领域知识整合与综合分析
- 识别收益递减点并高效终止研究"""


TASK_DECOMPOSITION_PROMPT = """请分析以下研究任务，并制定详细的研究计划。

<研究任务>
{task}
</研究任务>

请按照以下步骤进行深度分析和任务拆解：

## 第一步：评估和分解

1. **任务理解**：
   - 识别任务中的主要概念、关键实体和关系
   - 列出回答问题所需的具体事实或数据点
   - 注意问题的任何时间或上下文约束
   - 分析用户最关心什么？期望什么形式的输出？
   - 确定答案需要采取什么形式：详细报告、实体列表、对比分析、可视化报告等

## 第二步：查询类型确定

明确判断这个问题属于以下哪种类型：

### 深度优先查询
当问题需要对同一议题获取多个视角，通过从多个角度分析单一主题来"深入挖掘"时：
- 受益于探索不同观点、方法论或来源的并行智能体
- 核心问题保持单一但受益于多样化的方法
- 示例："治疗抑郁症最有效的方法是什么？"（探索不同治疗方法和观点）
- 示例："2008年金融危机的真正原因是什么？"（经济、监管、行为、历史视角）

### 广度优先查询
当问题可以分解为不同的、独立的子问题，需要通过收集每个子问题的信息来"横向扩展"时：
- 受益于每个处理单独子主题的并行智能体
- 查询自然分为多个可独立研究的子主题
- 示例："比较三个北欧国家的经济体系"（每个国家独立研究）
- 示例："根据性能、学习曲线、生态系统比较主要前端框架"

### 简单查询
当问题聚焦、定义明确，可以通过单一聚焦调查有效回答时：
- 可以由具有明确指令的单个子智能体有效处理
- 示例："东京目前的人口是多少？"（简单事实查找）
- 示例："所有财富500强公司是哪些？"（找到一个包含完整列表的网站）

## 第三步：详细研究计划制定

根据查询类型，制定具体的研究计划：

**对于深度优先查询**：
- 定义3-5种不同的方法论方法或视角
- 列出可以丰富分析的具体专家观点或证据来源
- 规划每个视角如何为核心问题提供独特见解
- 指定如何综合不同方法的发现

**对于广度优先查询**：
- 列举所有可以独立研究的子问题或子任务
- 识别最关键的子问题，避免为每个可能角度创建子智能体
- 根据重要性和研究复杂度对子任务进行优先级排序
- 定义清晰的子主题边界以防止重叠

**对于简单查询**：
- 确定最直接、高效的回答路径
- 指定回答所需的确切数据点
- 确定最可能相关的来源
- 规划基本的验证方法

## 第四步：子智能体数量确定

根据以下指南确定子智能体数量：
- **简单/直接查询**：1-2个子智能体
- **标准复杂度查询**：2-3个子智能体
- **中等复杂度查询**：3-5个子智能体
- **高复杂度查询**：5-8个子智能体（最多不超过10个）

**重要**：优先选择更少、更有能力的子智能体，而不是许多过于狭窄的子智能体。更多子智能体 = 更多开销。

请以 JSON 格式输出你的分析结果：

```json
{{
    "task_understanding": {{
        "core_objective": "研究的核心目标",
        "expected_output": "预期输出形式（详细报告/对比分析/实体列表等）",
        "key_dimensions": ["维度1", "维度2", "..."],
        "key_entities": ["关键实体1", "关键实体2"],
        "required_facts": ["需要收集的具体事实1", "事实2"],
        "time_constraints": "时间或上下文约束（如有）",
        "target_audience": "目标读者"
    }},
    "query_type": {{
        "type": "depth_first/breadth_first/simple",
        "reasoning": "判断依据说明",
        "recommended_approach": "推荐的研究方法概述"
    }},
    "research_plan": {{
        "strategy": "整体研究策略描述",
        "perspectives": ["视角1（仅深度优先）", "视角2"],
        "synthesis_plan": "如何综合不同发现"
    }},
    "subtasks": [
        {{
            "id": "task_1",
            "name": "子任务名称",
            "description": "详细描述这个子任务需要研究什么",
            "research_objective": "这个子任务的具体研究目标",
            "search_queries": ["建议的搜索关键词1", "搜索关键词2"],
            "expected_sources": ["推荐的信息来源类型"],
            "priority": "high/medium/low",
            "expected_output": "期望这个子任务产出什么信息",
            "scope_boundaries": "明确的范围边界，防止与其他任务重叠"
        }}
    ],
    "worker_count": {{
        "recommended": 3,
        "reasoning": "数量确定的依据"
    }},
    "report_structure": {{
        "title": "建议的报告标题",
        "sections": ["章节1", "章节2", "..."],
        "key_deliverables": ["关键交付物1", "交付物2"]
    }}
}}
```

请确保：
- 子任务之间尽量独立，可以并行执行
- 每个子任务有明确的研究范围、预期输出和范围边界
- 搜索关键词具体且有针对性（5个词以下）
- 子任务数量根据查询类型合理调整，避免过度拆分
- 如果所有子任务都很好地完成，将产生对用户查询的出色回答"""


SYNTHESIS_PROMPT = """你现在需要将多个研究子智能体的成果汇总成一份完整的研究报告。

<原始研究任务>
{original_task}
</原始研究任务>

<查询类型分析>
{query_type_analysis}
</查询类型分析>

<报告结构>
{report_structure}
</报告结构>

<各子智能体研究成果>
{worker_results}
</各子智能体研究成果>

在综合报告之前，请先进行以下分析：

## 综合前分析

1. **信息完整性检查**：
   - 审查所有子智能体收集的核心事实
   - 检查是否覆盖了任务要求的所有方面
   - 识别任何信息空白或不足

2. **信息质量评估**：
   - 评估各来源的可靠性（官方/权威媒体/一般来源）
   - 识别不同来源之间的任何差异或冲突
   - 对于冲突信息，根据时效性、与其他事实的一致性进行优先排序

3. **关键发现识别**：
   - 提取最重要的事实、数据和洞察
   - 识别跨多个子任务的共同主题或模式
   - 确定需要特别强调的突破性发现

## 报告生成要求

请按照以下要求生成最终报告：

1. **执行摘要**：用 3-5 句话概括核心发现和关键结论
2. **结构化内容**：按照报告结构组织内容，确保逻辑清晰
3. **数据支撑**：引用具体数据，使用上标标注引用编号（如 [1]、[2]）
4. **洞察分析**：不仅罗列信息，还要提供深度分析和批判性思考
5. **信息验证**：对于关键数据，优先使用经过多个来源验证的信息
6. **结论建议**：总结关键发现，提出可操作的建议或展望
7. **参考来源**：在报告末尾列出所有引用来源

报告格式要求：
- 使用 Markdown 格式
- 重要数据用**粗体**标注
- 适当使用表格展示对比数据
- 在正文中使用 [1]、[2] 等标注引用
- 语言专业但易读
- 对于推测性或未经验证的信息，明确标注

**引用格式要求**（非常重要）：
- 在报告正文中，每个关键数据或事实后用方括号标注引用编号
- 在报告末尾添加「## 参考来源」章节
- 列出所有引用的来源，格式如下：
  ```
  ## 参考来源

  [1] 来源名称 - 文章标题, URL链接
  [2] 来源名称 - 文章标题, URL链接
  ...
  ```

请直接输出完整的研究报告（包含参考来源章节）："""


QUALITY_CHECK_PROMPT = """请对以下研究报告进行全面质量检查和批判性评估：

<研究报告>
{report}
</研究报告>

<原始任务要求>
{original_task}
</原始任务要求>

<查询类型>
{query_type}
</查询类型>

请从以下维度进行深度评估：

## 评估维度

1. **完整性** (Completeness)：
   - 是否覆盖了任务要求的所有方面？
   - 是否有明显的信息空白？
   - 对于深度优先查询：是否探索了足够多的视角？
   - 对于广度优先查询：是否覆盖了所有必要的子主题？

2. **准确性** (Accuracy)：
   - 数据和信息是否准确可靠？
   - 是否存在未经验证或可疑的信息？
   - 来源质量如何？是否使用了权威来源？
   - 是否将推测误标为事实？

3. **深度** (Depth)：
   - 分析是否足够深入？
   - 是否提供了有价值的洞察而非仅罗列事实？
   - 因果关系和逻辑推理是否清晰？
   - 是否识别了关键模式和趋势？

4. **结构** (Structure)：
   - 组织结构是否清晰合理？
   - 逻辑流程是否通顺？
   - 章节之间过渡是否自然？
   - 信息层次是否分明？

5. **可读性** (Readability)：
   - 语言表达是否清晰易懂？
   - 专业术语使用是否恰当？
   - 是否有良好的格式和可视化？

6. **来源质量** (Source Quality)：
   - 引用的来源是否权威可靠？
   - 是否存在潜在的偏见来源？
   - 引用格式是否规范？

请以 JSON 格式输出评估结果：

```json
{{
    "overall_score": 85,
    "dimensions": {{
        "completeness": {{
            "score": 90,
            "strengths": ["优点1", "优点2"],
            "weaknesses": ["不足1"],
            "comment": "整体评价"
        }},
        "accuracy": {{
            "score": 85,
            "verified_facts": ["已验证的关键事实"],
            "unverified_claims": ["需要进一步验证的声明"],
            "comment": "评价"
        }},
        "depth": {{
            "score": 80,
            "strong_analysis": ["分析较好的方面"],
            "shallow_areas": ["分析不够深入的方面"],
            "comment": "评价"
        }},
        "structure": {{"score": 90, "comment": "评价"}},
        "readability": {{"score": 85, "comment": "评价"}},
        "source_quality": {{
            "score": 80,
            "high_quality_sources": ["优质来源"],
            "questionable_sources": ["可疑来源"],
            "comment": "评价"
        }}
    }},
    "critical_issues": ["严重问题（如有）"],
    "missing_aspects": ["缺失的重要方面"],
    "improvement_suggestions": ["具体改进建议"],
    "factual_conflicts": ["发现的事实冲突（如有）"],
    "needs_revision": true/false,
    "revision_priority": "high/medium/low"
}}
```"""


# ==================== Worker (SubAgent) Prompts ====================

SEARCH_WORKER_SYSTEM_PROMPT = f"""你是一个作为研究团队一部分工作的研究子智能体。当前日期是 {CURRENT_DATE}。

你被主研究智能体分配了一个明确的任务，应该使用可用的工具在研究过程中完成这个任务。

你的核心能力：
1. 执行高效的 OODA 循环（观察-定向-决策-行动）
2. 批判性评估来源质量
3. 识别和验证关键事实
4. 高效管理研究预算（工具调用次数）
5. 识别收益递减点并及时终止

你的工作原则：
- 保持认识论诚实，区分事实与推测
- 专注于高价值信息：重大的、重要的、精确的、高质量的
- 当遇到冲突信息时，根据时效性和来源质量进行优先排序
- 在研究过程中保持批判性思维，不盲目接受表面信息"""


SEARCH_WORKER_TASK_PROMPT = """请执行以下研究任务：

<任务信息>
任务ID: {task_id}
任务名称: {task_name}
任务描述: {task_description}
研究目标: {research_objective}
建议搜索词: {search_queries}
推荐来源类型: {expected_sources}
预期输出: {expected_output}
范围边界: {scope_boundaries}
</任务信息>

<搜索结果>
{search_results}
</搜索结果>

## 研究过程指南

### 1. 研究预算规划
根据任务复杂度确定你的"研究预算"：
- 简单任务（事实查找）：3-5次有效分析
- 中等任务：5-8次有效分析
- 复杂/多部分任务：8-12次有效分析
坚持这个预算以保持效率。

### 2. OODA 循环执行
在分析每批搜索结果后，执行 OODA 循环：

**(a) 观察 (Observe)**：
- 到目前为止收集了什么信息？
- 还需要收集什么来完成任务？
- 哪些信息来源质量较高？

**(b) 定向 (Orient)**：
- 什么搜索策略最适合收集所需信息？
- 根据已学到的内容更新你的研究方向
- 识别信息空白和矛盾点

**(c) 决策 (Decide)**：
- 做出明智的决定以特定方式分析信息
- 确定哪些发现最重要
- 决定是否需要更多信息还是可以开始总结

**(d) 行动 (Act)**：
- 执行分析并提取关键信息
- 评估来源质量
- 更新发现列表

### 3. 来源质量评估
对每个来源进行批判性评估，注意以下问题指标：
- 是否是信息的原始来源而非聚合器？
- 是否使用了推测性语言（"可能"、"也许"、未来时态）？
- 是否有虚假权威或无名来源？
- 是否存在营销语言、spin 或误导性数据？
- 信息的时效性如何？

来源可靠性等级：
- **高**: 官方机构、政府网站、学术论文、权威行业报告
- **中**: 知名媒体、行业网站、专家博客
- **低**: 用户生成内容、匿名来源、明显有偏见的网站

### 4. 信息冲突处理
当遇到冲突的信息时：
- 记录所有不同版本
- 根据来源权威性、时效性、与其他事实的一致性进行优先排序
- 如果无法调和，在报告中标明冲突，由主研究员决定

### 5. 智能终止
当满足以下条件时停止研究：
- 已收集到足够回答任务的信息
- 继续搜索出现收益递减（不再找到新的相关信息）
- 达到研究预算上限

请基于搜索结果，输出你的研究成果：

```json
{{
    "task_id": "{task_id}",
    "task_name": "{task_name}",
    "ooda_cycles": [
        {{
            "cycle": 1,
            "observe": "观察到的信息和状态",
            "orient": "分析和方向调整",
            "decide": "做出的决定",
            "act": "执行的行动和结果"
        }}
    ],
    "key_findings": [
        {{
            "finding": "关键发现描述",
            "data": "相关数据（如有）",
            "source": "来源名称",
            "source_url": "来源URL",
            "source_type": "original/aggregator/expert/official",
            "reliability": "high/medium/low",
            "reliability_reasoning": "可靠性判断依据",
            "date": "信息日期",
            "is_verified": true/false,
            "verification_notes": "验证说明"
        }}
    ],
    "summary": "本任务的研究总结（200-500字）",
    "data_points": [
        {{
            "metric": "指标名",
            "value": "值",
            "source": "来源",
            "confidence": "high/medium/low"
        }}
    ],
    "insights": ["洞察1", "洞察2"],
    "source_quality_assessment": {{
        "high_quality_sources": ["优质来源列表"],
        "questionable_sources": ["可疑来源及原因"],
        "source_conflicts": ["来源之间的冲突（如有）"]
    }},
    "information_gaps": ["未能找到的信息"],
    "speculative_vs_factual": {{
        "verified_facts": ["已验证的事实"],
        "speculative_claims": ["推测性声明（需标明）"]
    }},
    "limitations": "研究的局限性或需要补充的方面",
    "confidence_level": "high/medium/low",
    "confidence_reasoning": "置信度判断依据",
    "research_budget_used": "实际使用的分析轮次",
    "termination_reason": "研究终止原因（完成/收益递减/预算耗尽）"
}}
```

请确保：
- 所有数据都有明确来源和可靠性评估
- 严格区分事实和推测/观点
- 标注信息的时效性
- 指出任何矛盾或不一致的信息
- 对潜在问题来源进行标记
- 保持认识论诚实，只报告准确信息"""


WRITER_WORKER_SYSTEM_PROMPT = f"""你是一位专业的研究报告写作专家。
当前日期是 {CURRENT_DATE}。

你的职责：
1. 将研究数据转化为专业的报告内容
2. 确保内容逻辑清晰、论述有力
3. 使用恰当的数据可视化建议
4. 保持客观专业的写作风格

你的写作原则：
- 数据驱动：用数据支撑每个论点
- 结构清晰：层次分明，逻辑通顺
- 洞察深刻：不只罗列，更要分析
- 语言精练：专业但不晦涩
- 认识论诚实：区分事实与推测"""


WRITER_SECTION_PROMPT = """请为研究报告撰写以下章节：

<章节信息>
章节标题: {section_title}
章节要求: {section_requirements}
</章节信息>

<相关研究数据>
{research_data}
</相关研究数据>

<来源质量信息>
{source_quality}
</来源质量信息>

<报告上下文>
报告主题: {report_topic}
目标读者: {target_audience}
</报告上下文>

请撰写该章节内容，要求：

1. **内容完整**：覆盖该章节应包含的所有关键点
2. **数据支撑**：引用研究数据中的具体数字和事实，标注引用编号
3. **逻辑清晰**：论述有条理，过渡自然
4. **格式规范**：使用 Markdown 格式，适当使用列表、表格
5. **区分事实与推测**：对于推测性内容明确标注
6. **来源质量说明**：对于关键数据，说明来源的可靠性

请直接输出章节内容（Markdown 格式）："""


# ==================== 辅助 Prompts ====================

QUERY_EXPANSION_PROMPT = """请为以下研究任务生成多个搜索查询词：

<研究任务>
{task}
</研究任务>

<任务类型>
{query_type}
</任务类型>

要求：
1. 生成 3-5 个不同角度的搜索查询
2. 保持查询简短（5个词以下），因为这会返回更有用的结果
3. 包含中英文关键词（如适用）
4. 考虑不同的搜索意图：
   - 事实查找（具体数据、日期、数字）
   - 深度分析（专家观点、研究报告）
   - 最新动态（近期新闻、最新发展）
   - 案例研究（具体实例、应用场景）
5. 避免过于具体的查询（可能命中率低）
6. 根据结果质量调整具体程度

请以 JSON 格式输出：

```json
{{
    "queries": [
        {{
            "query": "搜索词1",
            "intent": "搜索意图（fact/analysis/news/case）",
            "language": "zh/en",
            "expected_source_type": "期望的来源类型",
            "priority": "high/medium/low"
        }}
    ],
    "search_strategy": "整体搜索策略说明"
}}
```"""


FACT_CHECK_PROMPT = """请验证以下信息的准确性：

<待验证信息>
{information}
</待验证信息>

<相关来源>
{sources}
</相关来源>

请进行批判性分析：

1. **来源评估**：
   - 每个来源的权威性和可靠性如何？
   - 是原始来源还是二手转述？
   - 是否存在明显的偏见或利益冲突？

2. **信息一致性**：
   - 信息是否与来源内容一致？
   - 不同来源之间是否存在矛盾？
   - 矛盾信息如何调和？

3. **时效性检查**：
   - 信息的时效性如何？
   - 是否有更新的数据可用？

4. **事实 vs 推测**：
   - 哪些是已验证的事实？
   - 哪些是推测或预测？

以 JSON 格式输出：

```json
{{
    "verified": true/false,
    "confidence": "high/medium/low",
    "verified_facts": ["已验证的事实"],
    "unverified_claims": ["未能验证的声明"],
    "speculative_content": ["推测性内容"],
    "source_quality": {{
        "high_quality": ["优质来源"],
        "questionable": ["可疑来源及原因"]
    }},
    "conflicts": ["矛盾点及来源"],
    "resolution": "冲突解决建议",
    "recommendation": "使用建议"
}}
```"""


# ==================== 迭代优化 Prompts ====================

GAP_ANALYSIS_PROMPT = """请分析当前研究报告的不足之处，识别需要补充研究的方向。

<原始研究任务>
{original_task}
</原始研究任务>

<查询类型>
{query_type}
</查询类型>

<当前研究报告>
{current_report}
</当前研究报告>

<质量检查结果>
{quality_result}
</质量检查结果>

<当前迭代次数>
第 {iteration} 次迭代（共 {max_iterations} 次）
</当前迭代次数>

请深入分析报告的薄弱环节，并生成补充研究任务：

## 1. 差距识别

### 信息完整性差距
- 哪些方面覆盖不足或完全缺失？
- 对于深度优先查询：是否缺少重要视角？
- 对于广度优先查询：是否有子主题未被覆盖？

### 数据质量差距
- 哪些数据/论据不够有力或缺乏可靠来源？
- 是否存在未经验证的关键声明？
- 是否有来源质量问题需要解决？

### 分析深度差距
- 哪些分析过于表面，需要深入？
- 是否缺少关键的因果分析或趋势识别？
- 洞察是否足够有价值？

### 事实准确性问题
- 是否发现任何可能不准确的信息？
- 是否有需要交叉验证的关键数据？

## 2. 补充任务生成

针对识别出的差距，设计具体的补充搜索任务：
- 任务应聚焦且可执行
- 避免与已有内容重复
- 优先处理高优先级差距
- 每个任务应有明确的研究目标和预期输出

请以 JSON 格式输出：

```json
{{
    "gap_analysis": {{
        "completeness_gaps": {{
            "missing_aspects": ["缺失方面1", "缺失方面2"],
            "missing_perspectives": ["缺失视角（深度优先查询适用）"],
            "uncovered_subtopics": ["未覆盖子主题（广度优先查询适用）"]
        }},
        "data_quality_gaps": {{
            "weak_sections": [
                {{"section": "章节名", "issue": "问题描述", "severity": "high/medium/low"}}
            ],
            "unverified_claims": ["需要验证的声明"],
            "source_quality_issues": ["来源质量问题"]
        }},
        "depth_gaps": {{
            "shallow_analysis": ["需要深入分析的点"],
            "missing_insights": ["缺失的洞察类型"]
        }},
        "accuracy_concerns": {{
            "questionable_facts": ["可疑事实"],
            "needs_verification": ["需要交叉验证的数据"]
        }}
    }},
    "supplementary_tasks": [
        {{
            "id": "sup_task_1",
            "name": "补充任务名称",
            "description": "详细描述需要补充研究的内容",
            "research_objective": "具体研究目标",
            "search_queries": ["搜索词1", "搜索词2"],
            "expected_sources": ["推荐的来源类型"],
            "target_gap": "针对哪个差距",
            "priority": "high/medium/low",
            "expected_output": "期望产出",
            "scope_boundaries": "范围边界"
        }}
    ],
    "refinement_focus": ["报告修订时需要重点关注的方面1", "方面2"],
    "verification_tasks": ["需要进行的事实验证任务"],
    "stop_iteration_recommendation": {{
        "should_stop": false,
        "reasoning": "是否建议停止迭代的理由"
    }}
}}
```

请确保：
- 补充任务数量在 2-4 个之间，聚焦最关键的差距
- 避免生成与已有研究重复的任务
- 优先补充高优先级的差距
- 如果报告已经足够好，建议停止迭代以节省资源"""


REPORT_REFINEMENT_PROMPT = """请基于补充研究成果，对原报告进行修订和优化。

<原始研究任务>
{original_task}
</原始研究任务>

<原始报告>
{original_report}
</原始报告>

<差距分析>
{gap_analysis}
</差距分析>

<补充研究成果>
{supplementary_results}
</补充研究成果>

<修订重点>
{refinement_focus}
</修订重点>

<需要验证的事实>
{verification_tasks}
</需要验证的事实>

请按以下步骤修订报告：

## 1. 信息整合
- 将补充研究的新发现融入相关章节
- 确保新信息与原有内容逻辑连贯
- 避免简单堆砌，要有机融合

## 2. 薄弱环节强化
- 针对差距分析中指出的问题进行加强
- 补充缺失的视角或子主题
- 深化原本分析不足的部分

## 3. 数据更新与验证
- 用新获取的数据替换或补充原有数据
- 对需要验证的事实进行确认或更正
- 更新来源质量评估

## 4. 准确性校正
- 修正任何发现的不准确信息
- 对推测性内容明确标注
- 解决之前识别的事实冲突

## 5. 引用更新
- 将新来源添加到参考来源章节
- 保持引用编号的连续性
- 确保所有新数据都有来源标注

修订要求：
- 保持原报告的整体结构和风格
- 新增内容要自然融入，不要有明显的"补充"痕迹
- 如有冲突的信息，采用更可靠来源的数据并说明
- 确保所有新数据都有来源标注
- 对于仍存在不确定性的内容，明确标注

**引用格式要求**（非常重要）：
- 保持原报告的引用编号格式 [1]、[2] 等
- 新增的数据同样需要添加引用编号
- 在报告末尾的「## 参考来源」章节中添加新的来源
- 引用编号要连续，新来源接在原有来源之后
- 格式：[编号] 来源名称 - 文章标题, URL链接

请直接输出修订后的完整报告（Markdown 格式，包含更新后的参考来源章节）："""


# ==================== 新增：智能终止判断 Prompt ====================

DIMINISHING_RETURNS_CHECK_PROMPT = """请评估当前研究是否已达到收益递减点。

<原始任务>
{original_task}
</原始任务>

<当前报告质量分数>
{current_score}
</当前报告质量分数>

<迭代历史>
{iteration_history}
</迭代历史>

<最近的补充研究成果>
{recent_supplementary_results}
</最近的补充研究成果>

请分析：

1. **质量提升趋势**：
   - 每次迭代的质量分数变化如何？
   - 提升幅度是否在递减？

2. **信息增量价值**：
   - 最近的补充研究是否带来了实质性的新信息？
   - 新信息对报告质量的贡献有多大？

3. **剩余差距评估**：
   - 剩余的信息差距是否关键？
   - 这些差距是否可以通过更多搜索有效填补？

4. **资源效率**：
   - 继续迭代的预期收益是否值得额外的资源消耗？

请以 JSON 格式输出：

```json
{{
    "diminishing_returns_detected": true/false,
    "reasoning": "判断依据",
    "quality_trend": {{
        "scores": [75, 80, 82],
        "improvement_rate": "提升率趋势",
        "plateauing": true/false
    }},
    "information_value": {{
        "recent_additions_value": "high/medium/low",
        "new_insights_count": 2,
        "substantive_improvements": ["实质性改进"]
    }},
    "remaining_gaps": {{
        "critical_gaps": ["关键差距"],
        "fillable_by_search": true/false
    }},
    "recommendation": {{
        "action": "continue/stop",
        "reasoning": "建议理由",
        "if_continue": "如果继续，应该聚焦什么"
    }}
}}
```"""


# ==================== 新增：并行任务协调 Prompt ====================

PARALLEL_TASK_COORDINATION_PROMPT = """请规划如何高效地并行执行多个研究子任务。

<子任务列表>
{subtasks}
</子任务列表>

<可用资源>
最大并行数: {max_workers}
</可用资源>

请分析：

1. **任务依赖关系**：
   - 哪些任务可以完全并行执行？
   - 哪些任务之间存在依赖（一个任务的结果影响另一个任务）？

2. **优先级排序**：
   - 基于重要性和预期复杂度对任务排序
   - 识别"阻塞任务"（其他任务依赖其结果）

3. **批次规划**：
   - 将任务分成可并行执行的批次
   - 确定每批次的最优任务组合

请以 JSON 格式输出：

```json
{{
    "dependency_analysis": {{
        "independent_tasks": ["可独立并行的任务ID"],
        "dependent_chains": [
            {{"first": "task_id", "then": "dependent_task_id", "reason": "依赖原因"}}
        ],
        "blocking_tasks": ["阻塞任务ID"]
    }},
    "execution_batches": [
        {{
            "batch": 1,
            "tasks": ["task_1", "task_2", "task_3"],
            "rationale": "为什么这些任务放在一起"
        }},
        {{
            "batch": 2,
            "tasks": ["task_4"],
            "depends_on": "batch_1",
            "rationale": "依赖第一批结果"
        }}
    ],
    "estimated_efficiency": "预计的效率提升",
    "coordination_notes": "协调注意事项"
}}
```"""
